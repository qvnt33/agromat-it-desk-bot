# Agromat IT-Desk Bot

Бот синхронізує YouTrack із Telegram: нові задачі автоматично з’являються у чаті з кнопкою «Прийняти», інженер може призначити себе в один клік, а зміни статусу та виконавця підтягуються, доки заявка не перейде в архів.

![agromat-it-desk-bot](docs/images/agromat_icon_empty.svg)

---

## Основні можливості
- Приймає вебхуки від YouTrack (створення та оновлення задач).
- Форматує та санітайзить HTML, підставляє fallback-теми й виконавців.
- Публікує повідомлення у Telegram з кнопкою «Прийняти».
- Призначає задачі в YouTrack **персональним токеном** користувача.
- Підтримує актуальний статус/опис/виконавця в Telegram, доки повідомленню не виповниться 48 годин.
- Після 48 годин заявка вважається **архівованою**: бот перестає редагувати повідомлення та лише фіксує в логах статус «Архівовано».
- (Опційно) Щотижня публікує розклад змін з Outlook/Exchange у Telegram і автоматично закріплює повідомлення.
- (Опційно) Щодня о заданій годині надсилає нагадування, хто чергує завтра.

---

## Як працює бот
1. **YouTrack створює задачу** → Automation App з `youtrack_app/yt2tg-app.zip` надсилає payload на `/youtrack`.
2. FastAPI-бекенд формує повідомлення, зберігає зв’язок `issue_id ↔ message_id` у SQLite та публікує запис у Telegram (Aiogram).
3. **Кнопка «Прийняти»**:
   - бот перевіряє авторизацію (збережений токен),
   - розшифровує персональний токен користувача,
   - через YouTrack REST API змінює статус/виконавця,
   - прибирає кнопку та оновлює повідомлення.
4. **Оновлення полів** у YouTrack (summary/description/state/assignee) генерують вебхук `/youtrack/update` → бот редагує наявне повідомлення.
5. **Через 48 годин** Telegram блокує редагування. Ми зупиняємо синхронізацію: повідомлення залишається у стані «Архівовано», нові зміни не відображаються.

---

## Авторизація та токени
- `/start` показує стан та інструкції; `/connect <youtrack_token>` реєструє користувача.
- Токени **не зберігаються у відкритому вигляді**. Ми:
  1. рахуємо SHA-256 для перевірки, чи змінився токен;
  2. шифруємо токен ключем `SHA-256(USER_TOKEN_SECRET)` і кладемо результат у поле `token_encrypted`.
- При натисканні «Прийняти» токен дешифрується й використовується для REST-запиту від імені користувача.
- Якщо `USER_TOKEN_SECRET` змінюється, усі повинні повторити `/connect`.
- `/unlink` видаляє шифротекст і хеш, після чого можна підключитися знову.

---

## Мінімальні налаштування
| Змінна              | Призначення                                                       |
|---------------------|-------------------------------------------------------------------|
| `BOT_TOKEN`         | токен Telegram-бота                                               |
| `TELEGRAM_CHAT_ID`  | ID чату/каналу, куди слати повідомлення                           |
| `YT_BASE_URL`       | базова адреса YouTrack                                            |
| `YT_TOKEN`          | сервісний токен (для технічних REST-запитів)                      |
| `YT_WEBHOOK_SECRET` | секрет, яким підписуються вебхуки Automation App                  |
| `USER_TOKEN_SECRET` | ключ для шифрування персональних токенів (обов’язково налаштувати)|
| `DATABASE_PATH` або `DATABASE_DIR`+`DATABASE_FILENAME` | шлях до SQLite (за замовчуванням `./data/bot.sqlite3`) |

### Розклад змін (опційно)
| Змінна                       | Призначення                                                                 |
|------------------------------|------------------------------------------------------------------------------|
| `SCHEDULE_EXCHANGE_EMAIL`    | поштова скринька з календарем змін                                          |
| `SCHEDULE_EXCHANGE_USERNAME` | логін для EWS (якщо відрізняється від email)                                |
| `SCHEDULE_EXCHANGE_PASSWORD` | пароль/додаткова парольна фраза                                             |
| `SCHEDULE_EXCHANGE_SERVER`   | кастомний хост Exchange (якщо `autodiscover` не працює)                     |
| `SCHEDULE_CALENDAR_NAME`     | альтернативна назва календаря (якщо не стандартний «Calendar»)              |
| `SCHEDULE_TIMEZONE`          | назва часової зони (default: `Europe/Kyiv`)                                 |
| `SCHEDULE_SEND_WEEKDAY`      | день, коли надсилати, `0=Пн ... 6=Нд` (default: `6`)                        |
| `SCHEDULE_SEND_TIME`         | локальний час у форматі `HH:MM` (default: `09:00`)                          |
| `SCHEDULE_DAILY_REMINDER_TIME`    | час нагадування, `HH:MM` (default: `18:00`)                           |

Розсилки графіка та щоденні нагадування завжди активні й використовують той самий `TELEGRAM_CHAT_ID`, що й основні повідомлення.

### Контроль статусу «Нова»
| Змінна                       | Призначення                                                                 |
|------------------------------|------------------------------------------------------------------------------|
| `NEW_STATUS_ALERT_ENABLED`   | `true/false`, вмикає нагадування про довгий статус «Нова»                    |
| `NEW_STATUS_STATE_NAME`      | текст статусу, який вважається «новим» (default: `Нова`)                     |
| `NEW_STATUS_ALERT_MINUTES_1` | затримка першого пінгу у хвилинах (default: `20`)                            |
| `NEW_STATUS_ALERT_MINUTES_2` | друга затримка (default: `60`)                                              |
| `NEW_STATUS_ALERT_MINUTES_3` | третя затримка (default: `120`)                                             |
| `NEW_STATUS_ALERT_MESSAGE_1` | текст повідомлення через перший таймер                                      |
| `NEW_STATUS_ALERT_MESSAGE_2` | текст повідомлення через другий таймер                                      |
| `NEW_STATUS_ALERT_MESSAGE_3` | текст повідомлення через третій таймер                                      |
| `NEW_STATUS_ALERT_POLL_MINUTES` | як часто перевіряти чергу нагадувань (у хвилинах, default: `1`)          |

Такі нагадування надсилаються як відповіді на початкове повідомлення заявки в Telegram.

### Автоархівування повідомлень
| Змінна                              | Призначення                                                               |
|-------------------------------------|----------------------------------------------------------------------------|
| `ARCHIVE_SCAN_INTERVAL_MINUTES`     | як часто шукати неактивні заявки (default: `10`)                          |
| `ARCHIVE_IDLE_THRESHOLD_MINUTES`    | через скільки хвилин без оновлень вважати заявку «Архівовано» (default: `2880`) |

Час вказують у хвилинах; допускаються дробові значення (наприклад, `0.5` для 30 секунд).

### Швидке розгортання
1. Скопіюйте `.env.example` у `.env`, заповніть потрібні значення.
2. Встановіть залежності: `pip install -r requirements.txt`.
3. У YouTrack → Administration → Apps → **Upload ZIP** завантажте `youtrack_app/yt2tg-app.zip`, задайте `WEBHOOK_BASE`, `WEBHOOK_SECRET`.
4. Додайте бота через BotFather, виконайте:
   ```bash
   curl -X POST https://api.telegram.org/bot$BOT_TOKEN/setWebhook \
        -d "url=https://<ваш-домен>/telegram" \
        -d "secret_token=$TELEGRAM_WEBHOOK_SECRET"
   ```
5. Запустіть бекенд (локально `uvicorn ... --reload` або через Docker `docker run -d --env-file .env -p 8080:8080 agromat-it-desk-bot`).
6. З Telegram виконайте `/start`, потім `/connect <персональний токен>` і підтвердьте.

---

## Обмеження та нюанси
- Один YouTrack-акаунт (`yt_user_id`) можна прив’язати тільки до одного Telegram. Щоб змінити чат – зробіть `/unlink`.
- Automation App відправляє тільки зміни контрольованих полів; якщо змінюється щось інше, бот цього не побачить.
- Після 48 годин бот **не редагує** Telegram-повідомлення й не створює нові – заявка фіксується як архівна.
- Для очищення середовища достатньо видалити `data/bot.sqlite3` і перезапустити сервіс.

---

## Структура репозиторію
- `agromat_it_desk_bot/main.py` – FastAPI застосунок + обробники вебхуків.
- `agromat_it_desk_bot/utils.py` – форматування повідомлень та санітайзинг.
- `youtrack_app/` – скрипти Automation App для YouTrack.
- `tests/` – unit та інтеграційні тести (використовують тестову SQLite).

> Питання або пропозиції — створюйте issue або пишіть у внутрішній чат команди.
